<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘é–€é«˜ç²± RWA çª–è—å¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/index.umd.min.js"></script>
    <style>
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <nav class="bg-blue-900 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">KKL RWA è¿½è¹¤ç³»çµ±</h1>
            <div id="accountDisplay" class="text-sm bg-blue-800 px-3 py-1 rounded">å°šæœªé€£æ¥éŒ¢åŒ…</div>
            <button id="connectBtn" class="bg-amber-500 hover:bg-amber-600 px-4 py-2 rounded font-bold transition">é€£æ¥éŒ¢åŒ…</button>
        </div>
    </nav>

    <main class="container mx-auto p-6">
        <div id="roleBadge" class="mb-6 inline-block px-4 py-1 rounded-full text-sm font-bold bg-gray-200 text-gray-700">
            ç•¶å‰èº«ä»½ï¼šè¨ªå®¢
        </div>

        <section id="adminSection" class="hidden mb-8 glass-card p-6 rounded-xl border-t-4 border-red-500 shadow">
            <h2 class="text-2xl font-bold mb-4 text-red-700">ğŸ›  ç®¡ç†è€…æ§åˆ¶å° (é…’å» å°ˆç”¨)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input id="mintTo" type="text" placeholder="æ¥æ”¶è€…åœ°å€ (0x...)" class="border p-2 rounded">
                <input id="mintUri" type="text" placeholder="IPFS Metadata URI" class="border p-2 rounded">
                <input id="mintBatch" type="text" placeholder="æ‰¹è™Ÿ (KKL-2024-01)" class="border p-2 rounded">
                <input id="mintVol" type="number" placeholder="å…¬å‡æ•¸" class="border p-2 rounded">
                <input id="mintLoc" type="text" placeholder="å„²å­˜ä½ç½® (å‘é“åç¨±)" class="border p-2 rounded">
                <button onclick="mintLiquor()" class="bg-red-600 text-white font-bold py-2 rounded hover:bg-red-700">é‘„é€ é«˜ç²±é…’è³‡ç”¢</button>
            </div>
        </section>

        <section id="vipSection" class="hidden mb-8 glass-card p-6 rounded-xl border-t-4 border-amber-500 shadow">
            <h2 class="text-2xl font-bold mb-4 text-amber-700">ğŸ‘‘ æˆ‘çš„ VIP çª–è—è³‡ç”¢</h2>
            <div id="myAssets" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <p class="text-gray-500 italic">æ­£åœ¨è®€å–æ‚¨çš„çª–è—è³‡æ–™...</p>
            </div>
        </section>

        <section class="glass-card p-6 rounded-xl border-t-4 border-blue-500 shadow">
            <h2 class="text-2xl font-bold mb-4 text-blue-700">ğŸ” é«˜ç²±é…’æº¯æºæŸ¥è©¢</h2>
            <div class="flex gap-2 mb-4">
                <input id="searchId" type="number" placeholder="è¼¸å…¥ Token ID (ä¾‹å¦‚: 0)" class="border p-2 flex-grow rounded">
                <button onclick="queryLiquor()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">æŸ¥è©¢</button>
            </div>
            <div id="queryResult" class="p-4 bg-blue-50 rounded hidden">
                </div>
        </section>
    </main>

    <script>
        // --- è¨­å®šå€ ---
        const contractAddress = "YOUR_CONTRACT_ADDRESS_HERE"; // âš ï¸ è«‹æ›´æ›ç‚ºä½ çš„åˆç´„åœ°å€
        const abi = [
            "function owner() view returns (address)",
            "function balanceOf(address) view returns (uint256)",
            "function mintLiquor(address,string,string,uint256,uint256,string) public",
            "function liquorRegistry(uint256) view returns (string,uint256,uint256,string,bool)",
            "function tokenOfOwnerByIndex(address,uint256) view returns (uint256)", // å¦‚æœæœ‰ä½¿ç”¨ ERC721Enumerable
            "function redeemLiquor(uint256) public"
        ];

        let provider, signer, contract;

        // --- åˆå§‹åŒ–èˆ‡è§’è‰²åˆ¤æ–· ---
        async function init() {
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                document.getElementById('connectBtn').addEventListener('click', connectWallet);
            } else {
                alert("è«‹å®‰è£ MetaMask éŒ¢åŒ…ï¼");
            }
        }

        async function connectWallet() {
            try {
                const accounts = await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                contract = new ethers.Contract(contractAddress, abi, signer);
                
                const userAddr = await signer.getAddress();
                document.getElementById('accountDisplay').innerText = `éŒ¢åŒ…: ${userAddr.substring(0,6)}...${userAddr.substring(38)}`;
                
                checkRole(userAddr);
            } catch (error) {
                console.error("é€£æ¥å¤±æ•—:", error);
            }
        }

        async function checkRole(userAddr) {
            const adminAddr = await contract.owner();
            const badge = document.getElementById('roleBadge');
            
            // 1. åˆ¤æ–·ç®¡ç†è€…
            if (userAddr.toLowerCase() === adminAddr.toLowerCase()) {
                badge.innerText = "ç•¶å‰èº«ä»½ï¼šé…’å» ç®¡ç†è€…";
                badge.className = "mb-6 inline-block px-4 py-1 rounded-full text-sm font-bold bg-red-100 text-red-700";
                document.getElementById('adminSection').classList.remove('hidden');
            } 
            
            // 2. åˆ¤æ–· VIP (æŒæœ‰è€…)
            const balance = await contract.balanceOf(userAddr);
            if (balance > 0n) {
                if (userAddr.toLowerCase() !== adminAddr.toLowerCase()) {
                    badge.innerText = "ç•¶å‰èº«ä»½ï¼šå°Šæ¦® VIP æŠ•è³‡è€…";
                    badge.className = "mb-6 inline-block px-4 py-1 rounded-full text-sm font-bold bg-amber-100 text-amber-700";
                }
                document.getElementById('vipSection').classList.remove('hidden');
                loadVipAssets(userAddr, balance);
            }
        }

        // --- åŠŸèƒ½æ“ä½œ ---
        async function mintLiquor() {
            const to = document.getElementById('mintTo').value;
            const uri = document.getElementById('mintUri').value;
            const batch = document.getElementById('mintBatch').value;
            const vol = document.getElementById('mintVol').value;
            const loc = document.getElementById('mintLoc').value;
            const date = Math.floor(Date.now() / 1000);

            try {
                const tx = await contract.mintLiquor(to, uri, batch, date, vol, loc);
                alert("é‘„é€ äº¤æ˜“å·²é€å‡ºï¼Œç­‰å¾…å€å¡Šéˆç¢ºèª...");
                await tx.wait();
                alert("é‘„é€ æˆåŠŸï¼");
            } catch (err) {
                alert("æ“ä½œå¤±æ•—: " + err.reason);
            }
        }

        async function queryLiquor() {
            const id = document.getElementById('searchId').value;
            try {
                const res = await contract.liquorRegistry(id);
                const resultDiv = document.getElementById('queryResult');
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `
                    <p><b>æ‰¹è™Ÿ:</b> ${res[0]}</p>
                    <p><b>é‡€é€ æ—¥æœŸ:</b> ${new Date(Number(res[1])*1000).toLocaleDateString()}</p>
                    <p><b>å®¹é‡:</b> ${res[2]} å…¬å‡</p>
                    <p><b>ç›®å‰å­˜æ”¾:</b> ${res[3]}</p>
                    <p><b>ç‹€æ…‹:</b> ${res[4] ? '<span class="text-red-500">å·²é ˜å–å¯¦é«”</span>' : '<span class="text-green-500">çª–è—ä¸­ (è³‡ç”¢æœ‰æ•ˆ)</span>'}</p>
                `;
            } catch (err) {
                alert("æ‰¾ä¸åˆ°è©²è³‡ç”¢ç·¨è™Ÿ");
            }
        }

        window.onload = init;
    </script>
</body>
</html>
